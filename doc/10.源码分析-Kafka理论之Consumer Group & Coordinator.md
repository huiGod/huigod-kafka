# Consumer Group

Consumer Group与Consumer Client的关联关系：
1. Consumer Group用group.id(String)作为全局唯一标识符
2. 每个Group可以有零个、一个或多个Consumer Client
3. 每个Group可以管理零个、一个或多个Topic
4. Group下每个Consumer Client可同时订阅Topic的一个或多个Partition
5. 同一个Partition只能被一个Group下的一个Client订阅，多Group下的Client订阅不受影响

Consumer Group的作用

- 管理Partition的Offset信息
- 管理Consumer Client与Partition的分配

正因为所有Partition的Offset信息是由Group统一管理，所以如果一个Partition对应有多个Consumer，那么每个Consumer在该Partition上的Offset很可能会不一致，这样会导致在Rebalance后赋值处理的Client的消费起点发生混乱；与此同时，这种场景也不符合Kafka中Partition消息消费的一致性；因此在同一Group下一个Partition只能对应一个Consumer Client

![å¨è¿éæå¥å¾çæè¿°](D:\user\文档\kafka\10.Kafka理论之Consumer Group & Coordinator.assets\20181226220049726.png)

# Group Coordinator

Group Coordinator是一个服务，每个Broker在启动的时候都会启动一个该服务。Group Coordinator的作用是用来存储Group的相关Meta信息，并将对应Partition的Offset信息记录到Kafka内置Topic(__consumer_offsets)中。Kafka在0.9之前是基于Zookeeper来存储Partition的Offset信息(consumers/{group}/offsets/{topic}/{partition})，因为ZK并不适用于频繁的写操作，所以在0.9之后通过内置Topic的方式来记录对应Partition的Offset

每个Group都会选择一个Coordinator来完成自己组内各Partition的Offset信息，选择的规则如下：

1. 计算Group对应在__consumer_offsets上的Partition

2. 根据对应的Partition寻找该Partition的leader所对应的Broker，该Broker上的Group Coordinator即就是该Group的Coordinator

Partition计算规则

```scala
partition-Id(__consumer_offsets) = Math.abs(groupId.hashCode() % groupMetadataTopicPartitionCount)
```

其中groupMetadataTopicPartitionCount对应offsets.topic.num.partitions参数值，默认值是50个分区

查看指定Partition各Replica的分布情况

```shell
bin/kafka-topics.sh --zookeeper <address:port> --topic __consumer_offsets --describe
```

# Group Coordinator Generation

Group Coordinaror是Group Rebalance中不可或缺的一环，因为Coordinator负责记录了每次Rebalance后的Partition分配结果，因此Kafka为Coordinator赋予了一个Generation的概念。Generation(谷歌翻译为“代”)可以通俗的理解为版本的概念，Generation未开始时值为-1，在第一次Rebalance后Group进入Stable状态时值为1，此后每发生一次Rebalance，Generation的Id会自增长加1

# Partition Assignment

Partition的分配策略和分配执行均是有Consumer Client完成的，而不是由Server(Group Coordinator)决定、执行的。因为如果换做用Server端实现，则不仅会增加Broker的负担，同时无法灵活的改变分配策略

## Assignment Strategy

Kafka目前支持RangeAssignor、RoundRobinAssignor两种内置的分配策略，在0.11.x以后还内置了一种分配策略StickyAssignor；当然因为Partition的分配策略是有Client控制的，所以Kafka支持用户自定义分配策略

# Rebalance

Rebalance是一个分区-客户端重分配协议。旨在特定条件下，基于给定的分配策略来为Group下所有Consumer Client重新分配所要订阅的Partition。Rebalance是Consumer Group中一个重要的特性，也为Group提供了High Availability and Scalability。但同样Rebalance也存在相应的弊端：在Rebalance期间，整个Group对外不可用

Rebalance 触发条件

- Group中有新Consumer加入
- Group中已有的Consumer挂掉
- Coordinator挂了，集群选出新Coordinator
- Topic新增Partition个数
- Consumer Client调用unsubscrible()，取消订阅Topic